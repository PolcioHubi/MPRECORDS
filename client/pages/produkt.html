<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Produkt - MP RECORDS</title>
    <link rel="icon" href="/assets/image/favicon.svg" type="image/svg+xml">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/pages/common.css">
    
    <style>
        .product-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 40px;
        }
        
        @media (min-width: 768px) {
            .product-container {
                grid-template-columns: 1fr 1fr;
                padding: 60px 40px;
            }
        }
        
        /* Gallery */
        .product-gallery {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .gallery-main {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            background: var(--black-lighter);
            aspect-ratio: 1;
        }
        
        .gallery-main img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: zoom-in;
        }
        
        .gallery-thumbs {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 8px;
        }
        
        .gallery-thumb {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid transparent;
            opacity: 0.6;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }
        
        .gallery-thumb.active,
        .gallery-thumb:hover {
            border-color: var(--purple);
            opacity: 1;
        }
        
        .gallery-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* Product Info */
        .product-info {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .product-category {
            font-size: 0.8rem;
            color: var(--purple-light);
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        .product-title {
            font-family: var(--font-minecraft);
            font-size: 1.2rem;
            color: var(--white);
        }
        
        .product-price {
            font-size: 2rem;
            font-weight: 700;
            color: var(--purple-light);
        }
        
        .product-desc {
            color: var(--gray);
            line-height: 1.7;
        }
        
        /* Size selector */
        .size-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .size-label {
            font-size: 0.9rem;
            color: var(--white);
        }
        
        .size-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .size-btn {
            min-width: 50px;
            padding: 12px 16px;
            background: var(--black-lighter);
            border: 2px solid rgba(124, 58, 237, 0.3);
            border-radius: 8px;
            color: var(--white);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .size-btn:hover {
            border-color: var(--purple);
        }
        
        .size-btn.active {
            background: var(--purple);
            border-color: var(--purple);
        }
        
        .size-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        /* Quantity */
        .quantity-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .quantity-controls {
            display: flex;
            align-items: center;
            background: var(--black-lighter);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .qty-btn {
            width: 40px;
            height: 40px;
            background: transparent;
            border: none;
            color: var(--white);
            font-size: 1.2rem;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .qty-btn:hover {
            background: var(--purple);
        }
        
        .qty-input {
            width: 50px;
            height: 40px;
            background: transparent;
            border: none;
            color: var(--white);
            text-align: center;
            font-size: 1rem;
        }
        
        /* Add to cart */
        .add-to-cart-btn {
            padding: 16px 32px;
            background: var(--purple);
            border: none;
            border-radius: 8px;
            color: var(--white);
            font-family: var(--font-minecraft);
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }
        
        .add-to-cart-btn:hover {
            background: var(--purple-dark);
            transform: translateY(-2px);
            box-shadow: 0 10px 30px var(--purple-glow);
        }
        
        .add-to-cart-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Stock info */
        .stock-info {
            font-size: 0.85rem;
            color: var(--gray);
        }
        
        .stock-info.in-stock { color: #22c55e; }
        .stock-info.low-stock { color: #f59e0b; }
        .stock-info.out-of-stock { color: #ef4444; }
        
        /* Lightbox */
        .lightbox {
            position: fixed;
            inset: 0;
            z-index: 9999;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .lightbox.active {
            opacity: 1;
            visibility: visible;
        }
        
        .lightbox-content {
            max-width: 90vw;
            max-height: 90vh;
            position: relative;
        }
        
        .lightbox-content img {
            max-width: 100%;
            max-height: 90vh;
            object-fit: contain;
        }
        
        .lightbox-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: rgba(124, 58, 237, 0.5);
            border: none;
            border-radius: 50%;
            color: var(--white);
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .lightbox-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 50px;
            height: 50px;
            background: rgba(124, 58, 237, 0.5);
            border: none;
            border-radius: 50%;
            color: var(--white);
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .lightbox-prev { left: 20px; }
        .lightbox-next { right: 20px; }
        
        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 16px 24px;
            background: var(--purple);
            color: var(--white);
            border-radius: 8px;
            font-size: 0.9rem;
            z-index: 9998;
            transform: translateX(150%);
            transition: transform 0.3s ease;
        }
        
        .toast.show {
            transform: translateX(0);
        }
    </style>
</head>
<body>
    <!-- Marquee Banner -->
    <div class="marquee-banner" id="marqueeBanner" style="display: none;">
        <div class="marquee-track">
            <span id="marqueeText1"></span>
            <span id="marqueeText2"></span>
        </div>
    </div>

    <!-- Particles Canvas -->
    <canvas id="particles-canvas"></canvas>
    
    <!-- Custom Cursor -->
    <div class="cursor-dot"></div>
    <div class="cursor-ring"></div>
    
    <!-- Header -->
    <header class="header">
        <div class="container">
            <a href="/" class="logo">
                <span class="logo-dot"></span>
                <span class="logo-text minecraft">MP RECORDS</span>
            </a>
            <nav class="nav">
                <a href="/wydania">WYDANIA</a>
                <a href="/sklep" class="active">SKLEP</a>
                <a href="/kontakt">KONTAKT</a>
                <a href="/czlonkowie">CZ≈ÅONKOWIE</a>
                <a href="/koszyk" class="cart-link">
                    üõí <span id="cartCount">0</span>
                </a>
            </nav>
        </div>
    </header>

    <!-- Product Content -->
    <main class="product-container" id="productContainer">
        <div class="loading"></div>
    </main>

    <!-- Lightbox -->
    <div class="lightbox" id="lightbox">
        <button class="lightbox-close" id="lightboxClose">√ó</button>
        <button class="lightbox-nav lightbox-prev" id="lightboxPrev">‚ùÆ</button>
        <div class="lightbox-content">
            <img src="" alt="" id="lightboxImg">
        </div>
        <button class="lightbox-nav lightbox-next" id="lightboxNext">‚ùØ</button>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <span class="footer-logo minecraft">MP RECORDS</span>
                <div class="footer-links">
                    <a href="/wydania">WYDANIA</a>
                    <a href="/sklep">SKLEP</a>
                    <a href="/kontakt">KONTAKT</a>
                    <a href="/czlonkowie">CZ≈ÅONKOWIE</a>
                </div>
                <span class="footer-year">¬© 2026</span>
            </div>
        </div>
    </footer>

    <script src="/js/utils/api.js"></script>
    <script>
        let product = null;
        let currentImageIndex = 0;
        let selectedSize = null;
        let quantity = 1;
        
        // Get product ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('id');
        
        document.addEventListener('DOMContentLoaded', async () => {
            if (!productId) {
                window.location.href = '/sklep';
                return;
            }
            
            await loadProduct();
            updateCartCount();
        });
        
        async function loadProduct() {
            const container = document.getElementById('productContainer');
            
            try {
                const response = await ProduktyAPI.getById(productId);
                product = response.data;
                
                document.title = `${product.nazwa} - MP RECORDS`;
                
                const images = product.zdjecia?.length > 0 
                    ? product.zdjecia 
                    : ['/assets/image/placeholder.png'];
                
                container.innerHTML = `
                    <div class="product-gallery">
                        <div class="gallery-main" id="galleryMain">
                            <img src="${images[0]}" alt="${product.nazwa}" id="mainImage">
                        </div>
                        ${images.length > 1 ? `
                            <div class="gallery-thumbs" id="galleryThumbs">
                                ${images.map((img, i) => `
                                    <div class="gallery-thumb ${i === 0 ? 'active' : ''}" data-index="${i}">
                                        <img src="${img}" alt="">
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="product-info">
                        <span class="product-category">${getCategoryName(product.kategoria)}</span>
                        <h1 class="product-title">${product.nazwa}</h1>
                        <span class="product-price">${product.cena?.toFixed(2) || '0.00'} PLN</span>
                        
                        ${product.opis ? `<p class="product-desc">${product.opis}</p>` : ''}
                        
                        ${product.rozmiary?.length > 0 ? `
                            <div class="size-section">
                                <span class="size-label">Wybierz rozmiar:</span>
                                <div class="size-options" id="sizeOptions">
                                    ${product.rozmiary.map(r => `
                                        <button class="size-btn ${r.stan <= 0 ? 'out-of-stock' : ''}" 
                                                data-size="${r.nazwa}" 
                                                data-stock="${r.stan}"
                                                ${r.stan <= 0 ? 'disabled' : ''}>
                                            ${r.nazwa}
                                            <small style="display: block; font-size: 0.6rem; margin-top: 2px; opacity: 0.7;">
                                                ${r.stan > 0 ? r.stan + ' szt.' : 'brak'}
                                            </small>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="quantity-section">
                            <span class="size-label">Ilo≈õƒá:</span>
                            <div class="quantity-controls">
                                <button class="qty-btn" id="qtyMinus">‚àí</button>
                                <input type="number" class="qty-input" id="qtyInput" value="1" min="1" max="10">
                                <button class="qty-btn" id="qtyPlus">+</button>
                            </div>
                        </div>
                        
                        <span class="stock-info" id="stockInfo">
                            ${product.rozmiary?.length > 0 ? 'Wybierz rozmiar' : getStockText(product.stanMagazynowy)}
                        </span>
                        
                        <button class="add-to-cart-btn" id="addToCartBtn" ${product.rozmiary?.length > 0 ? 'disabled' : (product.stanMagazynowy <= 0 ? 'disabled' : '')}>
                            ${product.stanMagazynowy <= 0 && !product.rozmiary?.length ? 'WYPRZEDANE' : 'DODAJ DO KOSZYKA'}
                        </button>
                    </div>
                `;
                
                setupGallery(images);
                setupSizeSelector();
                setupQuantity();
                setupAddToCart();
                
            } catch (error) {
                console.error('Error:', error);
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <p>Nie uda≈Ço siƒô za≈Çadowaƒá produktu</p>
                        <a href="/sklep" class="btn">Wr√≥ƒá do sklepu</a>
                    </div>
                `;
            }
        }
        
        function getCategoryName(cat) {
            const names = {
                'odziez': 'Odzie≈º',
                'akcesoria': 'Akcesoria',
                'muzyka': 'Muzyka',
                'inne': 'Inne'
            };
            return names[cat] || cat || '';
        }
        
        function getStockClass(stock) {
            if (stock <= 0) return 'out-of-stock';
            if (stock <= 5) return 'low-stock';
            return 'in-stock';
        }
        
        function getStockText(stock) {
            if (stock <= 0) return 'Brak na stanie';
            if (stock <= 5) return `Ostatnie ${stock} sztuk!`;
            return 'Dostƒôpny';
        }
        
        function setupGallery(images) {
            const mainImg = document.getElementById('mainImage');
            const thumbs = document.querySelectorAll('.gallery-thumb');
            const lightbox = document.getElementById('lightbox');
            const lightboxImg = document.getElementById('lightboxImg');
            
            // Click on main image - open lightbox
            document.getElementById('galleryMain').addEventListener('click', () => {
                lightboxImg.src = images[currentImageIndex];
                lightbox.classList.add('active');
            });
            
            // Thumbnails
            thumbs.forEach(thumb => {
                thumb.addEventListener('click', () => {
                    const index = parseInt(thumb.dataset.index);
                    currentImageIndex = index;
                    mainImg.src = images[index];
                    thumbs.forEach(t => t.classList.remove('active'));
                    thumb.classList.add('active');
                });
            });
            
            // Lightbox controls
            document.getElementById('lightboxClose').addEventListener('click', () => {
                lightbox.classList.remove('active');
            });
            
            lightbox.addEventListener('click', (e) => {
                if (e.target === lightbox) lightbox.classList.remove('active');
            });
            
            document.getElementById('lightboxPrev').addEventListener('click', (e) => {
                e.stopPropagation();
                currentImageIndex = (currentImageIndex - 1 + images.length) % images.length;
                lightboxImg.src = images[currentImageIndex];
            });
            
            document.getElementById('lightboxNext').addEventListener('click', (e) => {
                e.stopPropagation();
                currentImageIndex = (currentImageIndex + 1) % images.length;
                lightboxImg.src = images[currentImageIndex];
            });
            
            // Keyboard navigation
            document.addEventListener('keydown', (e) => {
                if (!lightbox.classList.contains('active')) return;
                if (e.key === 'Escape') lightbox.classList.remove('active');
                if (e.key === 'ArrowLeft') {
                    currentImageIndex = (currentImageIndex - 1 + images.length) % images.length;
                    lightboxImg.src = images[currentImageIndex];
                }
                if (e.key === 'ArrowRight') {
                    currentImageIndex = (currentImageIndex + 1) % images.length;
                    lightboxImg.src = images[currentImageIndex];
                }
            });
        }
        
        function setupSizeSelector() {
            const sizeBtns = document.querySelectorAll('.size-btn:not([disabled])');
            const addBtn = document.getElementById('addToCartBtn');
            const stockInfo = document.getElementById('stockInfo');
            
            sizeBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    selectedSize = btn.dataset.size;
                    
                    const stock = parseInt(btn.dataset.stock) || 0;
                    
                    // Update stock info
                    stockInfo.className = 'stock-info ' + getStockClass(stock);
                    stockInfo.textContent = getStockText(stock);
                    
                    // Update max quantity
                    const qtyInput = document.getElementById('qtyInput');
                    qtyInput.max = Math.min(stock, 10);
                    if (parseInt(qtyInput.value) > stock) {
                        qtyInput.value = stock;
                        quantity = stock;
                    }
                    
                    // Enable/disable add to cart
                    addBtn.disabled = stock <= 0;
                    addBtn.textContent = stock <= 0 ? 'WYPRZEDANE' : 'DODAJ DO KOSZYKA';
                });
            });
            
            // Auto-select first available size
            if (sizeBtns.length === 1) {
                sizeBtns[0].click();
            } else if (sizeBtns.length > 1) {
                // Show prompt to select size
                if (addBtn) addBtn.disabled = true;
            }
        }
        
        function setupQuantity() {
            const input = document.getElementById('qtyInput');
            const minus = document.getElementById('qtyMinus');
            const plus = document.getElementById('qtyPlus');
            
            minus.addEventListener('click', () => {
                if (quantity > 1) {
                    quantity--;
                    input.value = quantity;
                }
            });
            
            plus.addEventListener('click', () => {
                const maxStock = getMaxAvailableQuantity();
                if (quantity < maxStock) {
                    quantity++;
                    input.value = quantity;
                } else {
                    showToast(`Maksymalna dostƒôpna ilo≈õƒá: ${maxStock}`);
                }
            });
            
            input.addEventListener('change', () => {
                const maxStock = getMaxAvailableQuantity();
                quantity = Math.max(1, Math.min(maxStock, parseInt(input.value) || 1));
                input.value = quantity;
            });
        }
        
        function getMaxAvailableQuantity() {
            // Pobierz stan dla wybranego rozmiaru lub ca≈Çkowity
            let stock = 10;
            if (product.rozmiary?.length > 0 && selectedSize) {
                const sizeData = product.rozmiary.find(r => r.nazwa === selectedSize);
                stock = sizeData ? sizeData.stan : 0;
            } else if (!product.rozmiary?.length) {
                stock = product.stanMagazynowy || 0;
            }
            
            // Sprawd≈∫ ile ju≈º jest w koszyku
            const cart = JSON.parse(localStorage.getItem('mprecords_cart') || '[]');
            const inCart = cart.find(item => item.produktId === product._id && item.rozmiar === selectedSize);
            const alreadyInCart = inCart ? inCart.ilosc : 0;
            
            return Math.max(0, stock - alreadyInCart);
        }
        
        function setupAddToCart() {
            document.getElementById('addToCartBtn').addEventListener('click', () => {
                // Check if size needed
                if (product.rozmiary?.length > 0 && !selectedSize) {
                    showToast('Wybierz rozmiar!');
                    return;
                }
                
                addToLocalCart();
            });
        }
        
        function addToLocalCart() {
            // Pobierz stan magazynowy dla wybranego rozmiaru
            let maxStock = 0;
            if (product.rozmiary?.length > 0 && selectedSize) {
                const sizeData = product.rozmiary.find(r => r.nazwa === selectedSize);
                maxStock = sizeData ? sizeData.stan : 0;
            } else {
                maxStock = product.stanMagazynowy || 0;
            }
            
            // Get cart from localStorage
            let cart = JSON.parse(localStorage.getItem('mprecords_cart') || '[]');
            
            // Check if product already in cart
            const existingIndex = cart.findIndex(
                item => item.produktId === product._id && item.rozmiar === selectedSize
            );
            
            const alreadyInCart = existingIndex > -1 ? cart[existingIndex].ilosc : 0;
            const totalAfterAdd = alreadyInCart + quantity;
            
            // Sprawd≈∫ czy nie przekraczamy stanu magazynowego
            if (totalAfterAdd > maxStock) {
                if (alreadyInCart >= maxStock) {
                    showToast(`Masz ju≈º maksymalnƒÖ ilo≈õƒá w koszyku (${maxStock} szt.)`);
                    return;
                } else {
                    const canAdd = maxStock - alreadyInCart;
                    showToast(`Mo≈ºesz dodaƒá tylko ${canAdd} szt. (stan magazynowy: ${maxStock})`);
                    return;
                }
            }
            
            if (existingIndex > -1) {
                cart[existingIndex].ilosc += quantity;
                // Zapisz maxStock w koszyku do walidacji
                cart[existingIndex].maxStock = maxStock;
            } else {
                cart.push({
                    produktId: product._id,
                    nazwa: product.nazwa,
                    cena: product.cena,
                    zdjecie: product.zdjecia?.[0] || '/assets/image/placeholder.png',
                    rozmiar: selectedSize,
                    ilosc: quantity,
                    maxStock: maxStock
                });
            }
            
            localStorage.setItem('mprecords_cart', JSON.stringify(cart));
            updateCartCount();
            showToast('Dodano do koszyka!');
        }
        
        function updateCartCount() {
            const cart = JSON.parse(localStorage.getItem('mprecords_cart') || '[]');
            const count = cart.reduce((sum, item) => sum + item.ilosc, 0);
            document.getElementById('cartCount').textContent = count;
        }
        
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
    </script>
    <script src="/js/main.js"></script>
</body>
</html>
